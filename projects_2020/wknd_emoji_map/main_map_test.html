<!DOCTYPE html>
<html>

<head>
    <!-- need jQuery for AJXA -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Code from https://github.com/macek/jquery-serialize-object -->
    <script>
        /**
         * jQuery serializeObject
         * @copyright 2014, macek <paulmacek@gmail.com>
         * @link https://github.com/macek/jquery-serialize-object
         * @license BSD
         * @version 2.5.0
         */
        ! function(e, i) {
            if ("function" == typeof define && define.amd) define(["exports", "jquery"], function(e, r) {
                return i(e, r)
            });
            else if ("undefined" != typeof exports) {
                var r = require("jquery");
                i(exports, r)
            } else i(e, e.jQuery || e.Zepto || e.ender || e.$)
        }(this, function(e, i) {
            function r(e, r) {
                function n(e, i, r) {
                    return e[i] = r, e
                }

                function a(e, i) {
                    for (var r, a = e.match(t.key); void 0 !== (r = a.pop());)
                        if (t.push.test(r)) {
                            var u = s(e.replace(/\[\]$/, ""));
                            i = n([], u, i)
                        } else t.fixed.test(r) ? i = n([], r, i) : t.named.test(r) && (i = n({}, r, i));
                    return i
                }

                function s(e) {
                    return void 0 === h[e] && (h[e] = 0), h[e]++
                }

                function u(e) {
                    switch (i('[name="' + e.name + '"]', r).attr("type")) {
                        case "checkbox":
                            return "on" === e.value ? !0 : e.value;
                        default:
                            return e.value
                    }
                }

                function f(i) {
                    if (!t.validate.test(i.name)) return this;
                    var r = a(i.name, u(i));
                    return l = e.extend(!0, l, r), this
                }

                function d(i) {
                    if (!e.isArray(i)) throw new Error("formSerializer.addPairs expects an Array");
                    for (var r = 0, t = i.length; t > r; r++) this.addPair(i[r]);
                    return this
                }

                function o() {
                    return l
                }

                function c() {
                    return JSON.stringify(o())
                }
                var l = {},
                    h = {};
                this.addPair = f, this.addPairs = d, this.serialize = o, this.serializeJSON = c
            }
            var t = {
                validate: /^[a-z_][a-z0-9_]*(?:\[(?:\d*|[a-z0-9_]+)\])*$/i,
                key: /[a-z0-9_]+|(?=\[\])/gi,
                push: /^$/,
                fixed: /^\d+$/,
                named: /^[a-z0-9_]+$/i
            };
            return r.patterns = t, r.serializeObject = function() {
                return new r(i, this).addPairs(this.serializeArray()).serialize()
            }, r.serializeJSON = function() {
                return new r(i, this).addPairs(this.serializeArray()).serializeJSON()
            }, "undefined" != typeof i.fn && (i.fn.serializeObject = r.serializeObject, i.fn.serializeJSON = r.serializeJSON), e.FormSerializer = r, r
        });
    </script>

    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 30%;
            right: 0;
        }
        
        .emoji_div {
            font-size: xx-large;
        }
    </style>
    <script>
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js">
    </script>

    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>h
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
</head>

<body>
    <div id="form-wrapper" style="visibility: hidden;">
        <form id="input-form">
            <select name="emoji">
                <option disabled selected value>Select your emoji</option>
				<option id = "cry" value = "&#128557">&#128557</option>
				<option id = "scream" value = "&#129324">&#129324</option>
				<option id = "nap" value = "&#128564">&#128564</option>
				<option id = "date" value = "&#128158">&#128158</option>
				<option id = "eggplant" value = "&#127814">&#127814</option>
			</select>
            <br><br>
            <!-- hidden inputs -->
            <div style="display: none;">
                <input type="text" name="lat" id="lat_input" />
                <input type="text" name="long" id="lng_input" />
                <input type="text" name="time" id="time_input" />
            </div>

            <div>
                <label>Description Placeholder</label>
                <br>
                <textarea name="desc" id="desc_input" placeholder="Description Placeholder" rows="8"></textarea>
            </div>

            <div>
                <button type="submit" id="submit-form" class="btn btn-secondary">Submit</button>
            </div>

        </form>
    </div>


    <div id="map"></div>
    <script>
        // google script endpoint to send map data to
        const URL = 'https://script.google.com/macros/s/AKfycbyA9mleI7d_eBvNyLPiMvd_Kgj5xwqgWJIqHimtMrka96YLmJpC/exec'
        var description_text = "" // placeholder var to hold contents of "desc" in popup
        const POPUP_TEXT = document.getElementById('form-wrapper').innerHTML
        var markers = L.markerClusterGroup()

        // test locations, will remove later when pulling from github csv works
        var locations = [
            ["Pierson", 41.310970, -72.931990],
            ["Trumbull", 41.323910, -72.967180],
            ["Ben Frank", 41.330732, -72.921456],
            ["Ben Frank", 41.330732, -72.921456],
            ["Ben Frank", 41.330732, -72.921456]
        ];

        //all images from emojipedia, apple emojis
        var cryingIcon = L.icon({
            iconUrl: 'icons/crying.png',
            iconSize: [30, 30], // size of the icon
            iconAnchor: [0, 0], // point of the icon which will correspond to marker's location
            popupAnchor: [0, 0] // point from which the popup should open relative to the iconAnchor
        });
        var eggplantIcon = L.icon({
            iconUrl: 'icons/eggplant.png',
            iconSize: [30, 30], // size of the icon
            iconAnchor: [0, 0], // point of the icon which will correspond to marker's location
            popupAnchor: [0, 0] // point from which the popup should open relative to the iconAnchor
        });

        var textIcon = L.divIcon({
            html: '<p class=\'emoji_div\'> &#128557 </p>',
            iconSize: [50, 50], // size of the icon
            // iconAnchor: [0, 0], // point of the icon which will correspond to marker's location
            // popupAnchor: [0, 0], // point from which the popup should open relative to the iconAnchor
            className: ''
        });

        // display the map with the focus on New Haven
        var map = L.map('map').setView([41.310970, -72.931990], 25);
        L.tileLayer('https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key=wZnhwGRqtomo0QHvxpxW', {
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
        }).addTo(map);

        //build the intial map icons.
        function build_map_icons() {

            for (var i = 0; i < locations.length; i++) {
                marker = new L.marker([locations[i][1], locations[i][2]], {
                        icon: textIcon,
                        draggable: false
                    })
                    .bindPopup(locations[i][0]);

                markers.addLayer(marker)
            }

            map.addLayer(markers)
        }

        var popupGlobal; // this is ok for debugging
        //handle click events
        map.on('click', (e) => {


            console.log("map click")
            var popupLoc = e.latlng;
            popupGlobal = L.popup().setLatLng(popupLoc).setContent(POPUP_TEXT).openOn(map)

            // add the listeners for submit button and saving description text
            add_listeners(popupGlobal)
        })

        function add_listeners(popup) {
            console.log("trying to add listeners")

            // get the DOMs for popup and submit button
            var popupDom = $(popup.getElement())
            var button = popupDom.find("#submit-form")
            var textField = popupDom.find("#desc_input")

            // listener for saving descripton text
            popup.on('remove', () => description_text = textField.val())

            // fill in previous description text
            if (description_text != "") {
                textField.val(description_text)
            }


            // event listener for submit button
            button.on('click', function(e) {
                console.log("in button listener")
                var $form = popupDom.find("#input-form");
                var latlng = popup.getLatLng()

                // input in the coordinates
                popupDom.find("#lat_input").val(latlng.lat)
                popupDom.find("#lng_input").val(latlng.lng)

                // input in current time
                currentTime = new Date()
                popupDom.find("#time_input").val(currentTime.toGMTString())

                e.preventDefault();
                var jqxhr = $.ajax({
                    url: URL,
                    method: "GET",
                    dataType: "json",
                    data: $form.serializeObject(),
                    success: function() {
                        console.log("form succesfully sent!");
                    }
                });

                // clear saved description text
                textField.val("")
                popup.removeFrom(map)
            })
        }

        // add the test emojis to the map
        build_map_icons()
    </script>
    </div>

</body>

</html>

</html>